<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Checkout Section Begin -->
<section class="checkout spad">
    <div class="container" >
        <div class="row">
            {{!-- <div class="col-lg-12">
                <h6 class="coupon__link"><span class="icon_tag_alt"></span> <a href="#">Have a coupon?</a> Click
                    here to enter your code.</h6>
            </div> --}}
        </div>
        <form action="" class="checkout__form" id="checkoutform">
            <div class="row">
                
                <div class="col-lg-8">
                   <h5>Billing detail</h5>
                    {{!-- <div>
                     {{#each userAddress.Address}}
                        <div class="card" style="width: 40rem; height: 15rem;" >
                        <div class="card-body">
                            
                             <label for="paypal">
                                {{this.firstName}}
                            
                            <input type="checkbox" id="paypal" name="fname">
                            <span class="checkmark"></span>
                           
                        </label>
                        
                        </div>
                        </div>
                    
                       {{/each}}
                       
                        </div> --}}
                         {{#each userAddress.Address}}
                <div class="custom-control custom-checkbox me-sm-2 border">
                    <input type="radio" class="custom-control-input"
                        onclick="Select('{{this.fisrtName}}','{{this.lastName}}','{{this.address}}','{{this.place}}','{{this.district}}','{{this.pincode}}','{{this.mobile}}')"
                        value="" name="address" id="{{@index}}">
                    <label class="custom-control-label"
                        for="{{@index}}"><b>{{this.fisrtName}} {{this.lastName}}</b><br>{{this.address}},{{this.place}},{{this.district}}<br>{{this.pincode}},{{this.mobile}}</label>
                </div>
                {{/each}}
                <a  href="/addAddress" class="site-btn mt-4">Add Address</a>


                 <div class="discount__content"><br><br>
                    <h6>Discount codes</h6>
                     <form action=""> 
                        <div>
                            <input type="text" id="coupon" name="coupon" placeholder="Enter coupon code">
                            <button type="button" class="site-btn" onclick="couponApply()"
                                style="height: 45px;padding-left: 33px;">Apply</button>

                        </div>
                    </form>
                </div>



 {{!-- <form action="">
            <div class="input-group">
                <input type="text" id="coupon" name="coupon" class="form-control border-0 p-4"
                    placeholder="Coupon Code">
                <div class="input-group-append">
                    <a class="btn btn-dark " onclick="couponApply()">Apply Coupon</a>
                </div>
            </div>
        </form> --}}






                    <div class="row" hidden >
                        <div class="col-lg-6 col-md-6 col-sm-6" >
                            <div class="checkout__form__input">
                                <input name="Coupon" id="CouponName" type="text">
                                <p>First Name <span>*</span></p>
                                <input type="text" name="fname" id="fname" required>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="checkout__form__input">
                                <p>Last Name <span>*</span></p>
                                <input type="text" name="lname" id="lname" required>
                            </div>
                        </div>
                        <div class="col-lg-12">

                            <div class="checkout__form__input">
                                <p>Address <span>*</span></p>
                                <input type="text" name="address" id="address" required>
                            </div>
                            <div class="checkout__form__input">
                                <p>Town/City <span>*</span></p>
                                <input type="text" name="city" id="town">
                            </div>

                            <div class="checkout__form__input">
                                <p>District<span>*</span></p>
                                <input type="text" name="district" id="district" required>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="checkout__form__input">
                                <p>Pincode <span>*</span></p>
                                <input type="text" name="pincode" id="pincode" required>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="checkout__form__input">
                                <p>Phone <span>*</span></p>
                                <input type="text" name="number" id="phone">
                                <input type="text" name="userId" id="" value="{{users._id}}" hidden>
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="checkout__form__checkbox">

                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="checkout__order">
                        <h5>Your order</h5>
                        <div class="checkout__order__product">
                            <ul>
                               
                                <li>
                                    <span class="top__text">Product</span>
                                    <span class="top__text__right">Total</span>
                                </li>
                                 {{#each product}}
                                <li>{{this.product.name}} 
                                    <span>{{this.quantity}}* {{this.product.Amount}}</span></li>
                                {{!-- <li>02. Zip-pockets pebbled<br /> tote briefcase <span>$ 170.0</span></li>
                                <li>03. Black jean <span>$ 170.0</span></li>
                                <li>04. Cotton shirt <span>$ 110.0</span></li> --}}
                                {{/each}}
                            </ul>
                        </div>
                        <div class="checkout__order__total">
                            <ul>
                                <li>Discount  ₹<span id="discount">  0.00</span></li>
                                <li>Total ₹<span id="total">{{total}}</span></li>
                            </ul>
                        </div>
                       
                            <div class="form-check ml-4">
                                <input class="form-check-input" type="radio" name="payment-method" id="exampleRadios2"
                                    value="COD">
                                <label class="form-check-label" for="exampleRadios2">
                                    <b> COD</b>
                                </label>
                            </div>
                            <div class="form-check ml-4 mt-3 ">
                                <input class="form-check-input" type="radio" name="payment-method" id="exampleRadios2"
                                    value="paypal">
                                <label class="form-check-label" for="exampleRadios2">
                                    <b>Paypal</b>
                                </label>
                            </div>
                             <div class="form-check ml-4 mt-3 ">
                                <input class="form-check-input" type="radio" name="payment-method" id="exampleRadios2"
                                    value="razorepay">
                                <label class="form-check-label" for="exampleRadios2">
                                    <b>Razorepay</b>
                                </label>
                            </div>
                            {{#if showWallet}}
                             <div class="form-check ml-4 mt-3 ">
                                <input class="form-check-input" type="radio" name="payment-method" id="exampleRadios2"
                                    value="wallet">
                                <label class="form-check-label" for="exampleRadios2">
                                    <b>Wallet</b>
                                </label>
                            </div>
                            {{/if}}
                               


                            <button type="submit" class="site-btn mt-4">Place Oder</button>
                        </div>
                    </div>
                </div>
        </form>
    </div>
</section>
<!-- Checkout Section End -->



<script>

    function Select(Fname,Lname,address, town, district,pincode,phone) {
        document.getElementById('fname').value = Fname
        document.getElementById('lname').value = Lname
        document.getElementById('address').value = address
        document.getElementById('town').value = town
        document.getElementById('district').value = district
        document.getElementById('pincode').value = pincode
        document.getElementById('phone').value = phone
    }

</script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    $("#checkoutform").submit((e) => {

        e.preventDefault()
        $.ajax({
            url: '/checkOut',
            method: 'post',
            data: $('#checkoutform').serialize(),
            success: (response) => {
                if (response.cod) {
                Swal.fire('Order Placed Successfully').then(()=>{

                    location.href = '/order-placed'
                })

                }
                else if(response.paypal){
                location.href=response.link
                
                    
                }
                else if(response.wallet){
                    swal.fire('Order Placed Successfully').then(() => {
                        location.href = '/order-placed'
                    })
                } else{
                razorpayPayment(response)

                }

            }
        })
    })

     function razorpayPayment(order) {
        var options = {
            "key": "rzp_test_pj6dx0GRjB1fAZ", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "FOOTERS",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                verifyPayment(response, order)
            },
            "prefill": {
                "name": "vishnu",
                "email": "vishnu@example.com",
                "contact": "5555555555"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
    }

     function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify-payment',
            data: {
                payment,
                order
            },
            method: 'post',
            success: (response) => {
                console.log(response)
                if (response.status) {
                    Swal.fire('Order Placed Successfully').then(()=>{

                    location.href = '/order-placed'
                })
                    
                } else {
                    swal.fire('payment Failed')
                }
            }
        })
    }


</script>


<script>
    function couponApply() {
        console.log("entered")
        let couponCode = document.getElementById('coupon').value
        $.ajax({
            url: '/coupon-apply',
            data: {
                coupon: couponCode,
            },
            method: 'post',
            success: (response) => {
                if (response.couponSuccess) {
                    Swal.fire({
                        position: "center",
                        icon: "success",
                        title: "Coupon Applied Successfully",
                        showConfirmButton: false,
                        timer: 1000,
                    })
                    document.getElementById('total').innerHTML = response.total
                    document.getElementById('discount').innerHTML = response.discountValue
                    document.getElementById('CouponName').value = response.coupon
                    console.log(response.coupon)
                } else if (response.couponUsed) {
                    Swal.fire({
                        position: "center",
                        icon: "warning",
                        title: "You are Already Used This Coupon",
                        showConfirmButton: false,
                        timer: 1000,
                    });
                } else if (response.couponExpired) {
                    Swal.fire({
                        position: "center",
                        icon: "warning",
                        title: "Entered Coupon Expired",
                        showConfirmButton: false,
                        timer: 1000,
                    });
                } else {
                    Swal.fire({
                        position: "center",
                        icon: "warning",
                        title: "Invalid Coupon",
                        showConfirmButton: false,
                        timer: 1000,
                    });
                }
            }
        })
    }
</script>